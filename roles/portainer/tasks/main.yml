---
- name: Create Portainer data directory
  file:
    path: "{{ portainer_data_dir }}"
    state: directory

- name: Pull Portainer and agent images
  docker_image:
    name: "{{ item }}"
    source: pull
  loop:
    - portainer/portainer-ce:latest
    - portainer/agent:latest
    

- name: Deploy Portainer with Docker Compose
  docker_compose:
    project_name: portainer
    definition:
      version: '3'
      networks:
        macvlan_net:
          external: true
        internal:
          driver: bridge
      services:
        portainer-ce:
          image: portainer/portainer-ce:latest
          restart: unless-stopped
          networks:
            - macvlan_net
            - internal
          volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - "{{ portainer_data_dir }}:/data"
        portainer-agent:
          image: portainer/agent:latest
          restart: unless-stopped
          networks:
            - internal
          volumes:
            - "/var/run/docker.sock:/var/run/docker.sock"
            - "/var/lib/docker/volumes:/var/lib/docker/volumes"
    state: present

# - name: Assign static IP to portainer-ce container
#   ansible.builtin.command: docker network connect --ip 192.168.2.15 macvlan_net portainer_portainer-ce_1
#   args:
#     creates: /var/run/docker.sock
